<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Part01-集成Shiro实现博客详情-收藏文章 | Xblog</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/PicGo/logo/favicon.ico">
    <meta name="description" content="Project documentation">
    
    <link rel="preload" href="/PicGo/assets/css/0.styles.badde12b.css" as="style"><link rel="preload" href="/PicGo/assets/js/app.5da9f6f3.js" as="script"><link rel="preload" href="/PicGo/assets/js/2.38e92919.js" as="script"><link rel="preload" href="/PicGo/assets/js/20.52081bf9.js" as="script"><link rel="prefetch" href="/PicGo/assets/js/10.07cda984.js"><link rel="prefetch" href="/PicGo/assets/js/11.0a00ac59.js"><link rel="prefetch" href="/PicGo/assets/js/12.b3b58ca0.js"><link rel="prefetch" href="/PicGo/assets/js/13.9745ae2c.js"><link rel="prefetch" href="/PicGo/assets/js/14.b470fa3d.js"><link rel="prefetch" href="/PicGo/assets/js/15.c0409504.js"><link rel="prefetch" href="/PicGo/assets/js/16.df5ecfc2.js"><link rel="prefetch" href="/PicGo/assets/js/17.0bb6839c.js"><link rel="prefetch" href="/PicGo/assets/js/18.51f7e5c0.js"><link rel="prefetch" href="/PicGo/assets/js/19.3611637a.js"><link rel="prefetch" href="/PicGo/assets/js/21.617e8a9c.js"><link rel="prefetch" href="/PicGo/assets/js/22.0f9e2f2d.js"><link rel="prefetch" href="/PicGo/assets/js/23.7d8482de.js"><link rel="prefetch" href="/PicGo/assets/js/24.33daf0b9.js"><link rel="prefetch" href="/PicGo/assets/js/25.4e7ab2b5.js"><link rel="prefetch" href="/PicGo/assets/js/26.a2e0ad7b.js"><link rel="prefetch" href="/PicGo/assets/js/27.50f2ea4e.js"><link rel="prefetch" href="/PicGo/assets/js/28.52347f74.js"><link rel="prefetch" href="/PicGo/assets/js/3.87e74747.js"><link rel="prefetch" href="/PicGo/assets/js/4.5fc8d47d.js"><link rel="prefetch" href="/PicGo/assets/js/5.f280cf85.js"><link rel="prefetch" href="/PicGo/assets/js/6.c14ca87e.js"><link rel="prefetch" href="/PicGo/assets/js/7.8cba2e22.js"><link rel="prefetch" href="/PicGo/assets/js/8.ec65036e.js"><link rel="prefetch" href="/PicGo/assets/js/9.3da96484.js">
    <link rel="stylesheet" href="/PicGo/assets/css/0.styles.badde12b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/PicGo/" class="home-link router-link-active"><img src="/PicGo/logo/favicon.ico" alt="Xblog" class="logo"> <span class="site-name can-hide">Xblog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/halavah/blog/tree/master/xblog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  项目地址
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://halavah.github.io/halavah/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  关于我
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/halavah/blog/tree/master/xblog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  项目地址
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://halavah.github.io/halavah/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  关于我
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/PicGo/" aria-current="page" class="sidebar-link">快速入手</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Chapter01</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Chapter02</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Chapter03</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/PicGo/Chapter03/Part01-集成Shiro实现博客详情-收藏文章.html" class="active sidebar-link">Part01-集成Shiro实现博客详情-收藏文章</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/PicGo/Chapter03/Part01-集成Shiro实现博客详情-收藏文章.html#_1-1-博客详情-收藏文章【判断用户是否收藏了文章】" class="sidebar-link">1.1 博客详情：收藏文章【判断用户是否收藏了文章】</a></li><li class="sidebar-sub-header"><a href="/PicGo/Chapter03/Part01-集成Shiro实现博客详情-收藏文章.html#_1-2-博客详情-收藏文章【加入收藏】" class="sidebar-link">1.2 博客详情：收藏文章【加入收藏】</a></li><li class="sidebar-sub-header"><a href="/PicGo/Chapter03/Part01-集成Shiro实现博客详情-收藏文章.html#_1-3-博客详情-收藏文章【取消收藏】" class="sidebar-link">1.3 博客详情：收藏文章【取消收藏】</a></li><li class="sidebar-sub-header"><a href="/PicGo/Chapter03/Part01-集成Shiro实现博客详情-收藏文章.html#_1-4-其他-shiro自定义过滤器【判断请求是否是ajax请求-还是web请求】" class="sidebar-link">1.4 其他：Shiro自定义过滤器【判断请求是否是Ajax请求，还是Web请求】</a></li></ul></li><li><a href="/PicGo/Chapter03/Part02-集成Shiro实现博客详情-添加文章、编辑文章、提交文章.html" class="sidebar-link">Part02-集成Shiro实现博客详情-添加文章、编辑文章、提交文章</a></li><li><a href="/PicGo/Chapter03/Part03-集成Shiro实现博客详情-超级用户、删除、置顶、精华.html" class="sidebar-link">Part03-集成Shiro实现博客详情-超级用户、删除、置顶、精华</a></li><li><a href="/PicGo/Chapter03/Part04-集成Shiro实现博客详情-用户文章、用户评论.html" class="sidebar-link">Part04-集成Shiro实现博客详情-用户文章、用户评论</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Chapter04</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="part01-集成shiro实现博客详情-收藏文章"><a href="#part01-集成shiro实现博客详情-收藏文章" class="header-anchor">#</a> Part01-集成Shiro实现博客详情-收藏文章</h1> <div class="language-text extra-class"><pre class="language-text"><code>blog
├─src
│  └─main
│      ├─java
│      │  └─org
│      │      └─myslayers
│      │          ├─shiro
│      │          │      ShiroConfig.java
│      │          │
│      │          ├─controller
│      │          │      BaseController.java
│      │          │      PostController.java
│      │          │
│      │          ├─shiro
│      │          │      AuthFilter.java
</code></pre></div><h2 id="_1-1-博客详情-收藏文章【判断用户是否收藏了文章】"><a href="#_1-1-博客详情-收藏文章【判断用户是否收藏了文章】" class="header-anchor">#</a> 1.1 博客详情：收藏文章【判断用户是否收藏了文章】</h2> <ul><li><code>PostController.java</code> ：控制层，【判断用户是否收藏了文章】</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PostController</span> <span class="token keyword">extends</span> <span class="token class-name">BaseController</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 详情detail：判断用户是否收藏了文章
     */</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/collection/find/&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">collectionFind</span><span class="token punctuation">(</span><span class="token class-name">Long</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> count <span class="token operator">=</span> collectionService<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserCollection</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;user_id&quot;</span><span class="token punctuation">,</span> <span class="token function">getProfileId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;post_id&quot;</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//【/res/mods/jie.js】源码可知，异步渲染（layui.cache.user.uid != -1时，会调用/collection/find/接口）</span>
        <span class="token comment">//【/res/mods/jie.js】源码可知，异步渲染（res.data.collection ? '取消收藏' : '收藏'），count &gt; 0 为true时，则res.data.collection也为true</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token class-name">MapUtil</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">&quot;collection&quot;</span><span class="token punctuation">,</span> count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_1-2-博客详情-收藏文章【加入收藏】"><a href="#_1-2-博客详情-收藏文章【加入收藏】" class="header-anchor">#</a> 1.2 博客详情：收藏文章【加入收藏】</h2> <ul><li><code>PostController.java</code> ：控制层，【加入收藏】</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PostController</span> <span class="token keyword">extends</span> <span class="token class-name">BaseController</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 详情detail：【加入收藏】文章
     */</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/collection/add/&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">collectionAdd</span><span class="token punctuation">(</span><span class="token class-name">Long</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Post</span> post <span class="token operator">=</span> postService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//文章是否被删除</span>
        <span class="token comment">//如果【post != null】为true，则直接跳过该条语句；否则为false，则报异常【java.lang.IllegalArgumentException: 改帖子已被删除】</span>
        <span class="token comment">//等价写法【if (post == null) return Result.fail(&quot;该帖子已被删除&quot;);】</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>post <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;该文章已被删除&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//文章是否被收藏</span>
        <span class="token keyword">int</span> count <span class="token operator">=</span> collectionService<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserCollection</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;user_id&quot;</span><span class="token punctuation">,</span> <span class="token function">getProfileId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;post_id&quot;</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;你已经收藏&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//将该文章进行收藏</span>
        <span class="token class-name">UserCollection</span> collection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        collection<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span><span class="token function">getProfileId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        collection<span class="token punctuation">.</span><span class="token function">setPostId</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        collection<span class="token punctuation">.</span><span class="token function">setCreated</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        collection<span class="token punctuation">.</span><span class="token function">setModified</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        collection<span class="token punctuation">.</span><span class="token function">setPostUserId</span><span class="token punctuation">(</span>post<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        collectionService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>collection<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_1-3-博客详情-收藏文章【取消收藏】"><a href="#_1-3-博客详情-收藏文章【取消收藏】" class="header-anchor">#</a> 1.3 博客详情：收藏文章【取消收藏】</h2> <ul><li><code>PostController.java</code> ：控制层，【取消收藏】</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PostController</span> <span class="token keyword">extends</span> <span class="token class-name">BaseController</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 详情detail：【取消收藏】文章
     */</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/collection/remove/&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">collectionRemove</span><span class="token punctuation">(</span><span class="token class-name">Long</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Post</span> post <span class="token operator">=</span> postService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//文章是否被删除</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>post <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;该文章已被删除&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//将该文章进行删除</span>
        collectionService<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserCollection</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;user_id&quot;</span><span class="token punctuation">,</span> <span class="token function">getProfileId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;post_id&quot;</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_1-4-其他-shiro自定义过滤器【判断请求是否是ajax请求-还是web请求】"><a href="#_1-4-其他-shiro自定义过滤器【判断请求是否是ajax请求-还是web请求】" class="header-anchor">#</a> 1.4 其他：Shiro自定义过滤器【判断请求是否是Ajax请求，还是Web请求】</h2> <ul><li>场景：如果用户退出登录后，点击【收藏文章】，报错【请求异常，请重试】，如何弹窗提示【请先登录！】</li> <li>解决：Shiro 自定义过滤器，重写 UserFilter 父类中的 redirectToLogin() 方法</li> <li><code>AuthFilter.java</code> ：过滤器，判断请求是否是 Ajax 请求，还是 Web 请求</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthFilter</span> <span class="token keyword">extends</span> <span class="token class-name">UserFilter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">redirectToLogin</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>

        <span class="token comment">/**
         * Ajax请求：通过对request字段的处理，来判断如果为Ajax请求，则设置response返回一段Json请求，并弹窗提示【请先登录！】
         */</span>
        <span class="token class-name">HttpServletRequest</span> httpServletRequest <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> request<span class="token punctuation">;</span>
        <span class="token comment">//通过“X-Requested-With”来确定“该请求是一个Ajax请求”</span>
        <span class="token class-name">String</span> header <span class="token operator">=</span> httpServletRequest<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;X-Requested-With&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>header <span class="token operator">!=</span> <span class="token keyword">null</span>  <span class="token operator">&amp;&amp;</span> <span class="token string">&quot;XMLHttpRequest&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//isAuthenticated()：如果此主题/用户在当前会话期间通过提供与系统已知的凭据匹配的有效凭据来证明了自己的身份，则返回true否则返回false</span>
            <span class="token keyword">boolean</span> authenticated <span class="token operator">=</span> <span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAuthenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//如果!authenticated = true，则将resp设置为“返回一段Json数据”，Result.fail(&quot;请先登录！&quot;)会触发【弹窗】显示【请先登录！】</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>authenticated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">&quot;application/json;charset=UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span><span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;请先登录！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

            <span class="token comment">/**
             * Web请求，则重定向到【登录页面】，直接super.父类方法，无需对request、response进行处理
             */</span>
            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">redirectToLogin</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><code>ShiroConfig.java</code> ：配置类，安全管理器、拦截器链、自定义过滤器</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * Shiro配置类：安全管理器、拦截器链、自定义过滤器
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShiroConfig</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 安全管理器
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">SecurityManager</span> <span class="token function">securityManager</span><span class="token punctuation">(</span><span class="token class-name">AccountRealm</span> accountRealm<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">DefaultWebSecurityManager</span> securityManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultWebSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        securityManager<span class="token punctuation">.</span><span class="token function">setRealm</span><span class="token punctuation">(</span>accountRealm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;------------------&gt;securityManager注入成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> securityManager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 拦截器链
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">ShiroFilterFactoryBean</span> <span class="token function">shiroFilterFactoryBean</span><span class="token punctuation">(</span><span class="token class-name">SecurityManager</span> securityManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ShiroFilterFactoryBean</span> filterFactoryBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ShiroFilterFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 配置安全管理器</span>
        filterFactoryBean<span class="token punctuation">.</span><span class="token function">setSecurityManager</span><span class="token punctuation">(</span>securityManager<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 配置登录的url</span>
        filterFactoryBean<span class="token punctuation">.</span><span class="token function">setLoginUrl</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 配置登录成功的url</span>
        filterFactoryBean<span class="token punctuation">.</span><span class="token function">setSuccessUrl</span><span class="token punctuation">(</span><span class="token string">&quot;/user/center&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 配置未授权跳转页面</span>
        filterFactoryBean<span class="token punctuation">.</span><span class="token function">setUnauthorizedUrl</span><span class="token punctuation">(</span><span class="token string">&quot;/error/403&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 配置Shiro自定义过滤器：判断请求是否是Ajax请求，还是Web请求</span>
        filterFactoryBean<span class="token punctuation">.</span><span class="token function">setFilters</span><span class="token punctuation">(</span><span class="token class-name">MapUtil</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">&quot;auth&quot;</span><span class="token punctuation">,</span> <span class="token function">authFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 配置过滤链定义图：未登录的情况下，访问/login、/user/home页面，自动跳转登录页面进行认证</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> hashMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hashMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;/res/**&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;anon&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        hashMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;/user/home&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;auth&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hashMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;/user/set&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;auth&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hashMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;/user/upload&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;auth&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        hashMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;/user/index&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;auth&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hashMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;/user/public&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;auth&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hashMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;/user/collection&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;auth&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hashMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;/user/mess&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;auth&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hashMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;/msg/remove/&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;auth&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hashMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;/message/nums/&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;auth&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        hashMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;/collection/remove/&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;auth&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hashMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;/collection/find/&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;auth&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hashMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;/collection/add/&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;auth&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        hashMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;/post/edit&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;auth&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hashMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;/post/submit&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;auth&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hashMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;/post/delete&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;auth&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hashMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;/post/reply/&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;auth&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        hashMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;/websocket&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;anon&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hashMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;anon&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        filterFactoryBean<span class="token punctuation">.</span><span class="token function">setFilterChainDefinitionMap</span><span class="token punctuation">(</span>hashMap<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> filterFactoryBean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Shiro自定义过滤器：判断请求是否是Ajax请求，还是Web请求
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">AuthFilter</span> <span class="token function">authFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AuthFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><code>static/res/mods/index.js</code> ：源码可知，如果 status 为 0 ，则代表登录成功；status 为 -1，则代表登录失败，并弹窗显示 msg 内容</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//Ajax</span>
<span class="token function-variable function">json</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> data<span class="token punctuation">,</span> success<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> that <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token keyword">typeof</span> data <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        options <span class="token operator">=</span> success
        success <span class="token operator">=</span> data<span class="token punctuation">;</span>
        data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    options <span class="token operator">=</span> options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        type<span class="token operator">:</span> options<span class="token punctuation">.</span>type <span class="token operator">||</span> <span class="token string">'post'</span><span class="token punctuation">,</span>
        dataType<span class="token operator">:</span> options<span class="token punctuation">.</span>dataType <span class="token operator">||</span> <span class="token string">'json'</span><span class="token punctuation">,</span>
        data<span class="token operator">:</span> data<span class="token punctuation">,</span>
        url<span class="token operator">:</span> url<span class="token punctuation">,</span>
        <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                success <span class="token operator">&amp;&amp;</span> <span class="token function">success</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                layer<span class="token punctuation">.</span><span class="token function">msg</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>msg <span class="token operator">||</span> res<span class="token punctuation">.</span>code<span class="token punctuation">,</span> <span class="token punctuation">{</span>shift<span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//弹窗显示【返回的&quot;msg&quot;内容】</span>
                options<span class="token punctuation">.</span>error <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function-variable function">error</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            layer<span class="token punctuation">.</span><span class="token function">msg</span><span class="token punctuation">(</span><span class="token string">'请求异常，请重试'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>shift<span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            options<span class="token punctuation">.</span>error <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">5/13/2021, 5:23:11 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/PicGo/Chapter02/Part05-集成Shiro实现个人账户-我的消息.html" class="prev">
        Part05-集成Shiro实现个人账户-我的消息
      </a></span> <span class="next"><a href="/PicGo/Chapter03/Part02-集成Shiro实现博客详情-添加文章、编辑文章、提交文章.html">
        Part02-集成Shiro实现博客详情-添加文章、编辑文章、提交文章
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/PicGo/assets/js/app.5da9f6f3.js" defer></script><script src="/PicGo/assets/js/2.38e92919.js" defer></script><script src="/PicGo/assets/js/20.52081bf9.js" defer></script>
  </body>
</html>
