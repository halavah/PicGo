<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Part05-集成Shiro实现个人账户-我的消息 | Xblog</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/test/logo/favicon.ico">
    <meta name="description" content="Project documentation">
    
    <link rel="preload" href="/test/assets/css/0.styles.1811a760.css" as="style"><link rel="preload" href="/test/assets/js/app.6710735c.js" as="script"><link rel="preload" href="/test/assets/js/2.5b8d21c8.js" as="script"><link rel="preload" href="/test/assets/js/19.99769197.js" as="script"><link rel="prefetch" href="/test/assets/js/10.16589aca.js"><link rel="prefetch" href="/test/assets/js/11.ccdd61e4.js"><link rel="prefetch" href="/test/assets/js/12.ea2e7635.js"><link rel="prefetch" href="/test/assets/js/13.2f87eeae.js"><link rel="prefetch" href="/test/assets/js/14.83934acd.js"><link rel="prefetch" href="/test/assets/js/15.80219037.js"><link rel="prefetch" href="/test/assets/js/16.daccab4e.js"><link rel="prefetch" href="/test/assets/js/17.c287f753.js"><link rel="prefetch" href="/test/assets/js/18.01402f92.js"><link rel="prefetch" href="/test/assets/js/20.b187f33a.js"><link rel="prefetch" href="/test/assets/js/21.e1747b39.js"><link rel="prefetch" href="/test/assets/js/22.ad38be71.js"><link rel="prefetch" href="/test/assets/js/23.17be09d6.js"><link rel="prefetch" href="/test/assets/js/24.c1ad7e7a.js"><link rel="prefetch" href="/test/assets/js/25.50e45c23.js"><link rel="prefetch" href="/test/assets/js/26.d32de95a.js"><link rel="prefetch" href="/test/assets/js/27.4a36609b.js"><link rel="prefetch" href="/test/assets/js/28.d387297e.js"><link rel="prefetch" href="/test/assets/js/3.87e74747.js"><link rel="prefetch" href="/test/assets/js/4.a5623ace.js"><link rel="prefetch" href="/test/assets/js/5.e8fc06c9.js"><link rel="prefetch" href="/test/assets/js/6.91b36dcf.js"><link rel="prefetch" href="/test/assets/js/7.dac76fb7.js"><link rel="prefetch" href="/test/assets/js/8.66dcb99f.js"><link rel="prefetch" href="/test/assets/js/9.bb572502.js">
    <link rel="stylesheet" href="/test/assets/css/0.styles.1811a760.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/test/" class="home-link router-link-active"><img src="/test/logo/favicon.ico" alt="Xblog" class="logo"> <span class="site-name can-hide">Xblog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/halavah/blog/tree/master/xblog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  项目地址
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://halavah.tk" target="_blank" rel="noopener noreferrer" class="nav-link external">
  关于我
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/halavah/blog/tree/master/xblog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  项目地址
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://halavah.tk" target="_blank" rel="noopener noreferrer" class="nav-link external">
  关于我
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/test/" aria-current="page" class="sidebar-link">快速入手</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Chapter01</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Chapter02</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/test/Chapter02/Part01-集成Kaptcha实现用户注册.html" class="sidebar-link">Part01-集成Kaptcha实现用户注册</a></li><li><a href="/test/Chapter02/Part02-集成Shiro实现用户登录.html" class="sidebar-link">Part02-集成Shiro实现用户登录</a></li><li><a href="/test/Chapter02/Part03-集成Shiro实现个人账户-我的主页、基本设置.html" class="sidebar-link">Part03-集成Shiro实现个人账户-我的主页、基本设置</a></li><li><a href="/test/Chapter02/Part04-集成Shiro实现个人账户-用户中心.html" class="sidebar-link">Part04-集成Shiro实现个人账户-用户中心</a></li><li><a href="/test/Chapter02/Part05-集成Shiro实现个人账户-我的消息.html" class="active sidebar-link">Part05-集成Shiro实现个人账户-我的消息</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/test/Chapter02/Part05-集成Shiro实现个人账户-我的消息.html#_5-1-个人账户-我的消息【查询消息】" class="sidebar-link">5.1 个人账户：我的消息【查询消息】</a></li><li class="sidebar-sub-header"><a href="/test/Chapter02/Part05-集成Shiro实现个人账户-我的消息.html#_5-2-个人账户-我的消息【删除单个消息-或-删除全部消息】" class="sidebar-link">5.2 个人账户：我的消息【删除单个消息 或 删除全部消息】</a></li><li class="sidebar-sub-header"><a href="/test/Chapter02/Part05-集成Shiro实现个人账户-我的消息.html#_5-3-个人账户-我的消息【消息弹窗】" class="sidebar-link">5.3 个人账户：我的消息【消息弹窗】</a></li><li class="sidebar-sub-header"><a href="/test/Chapter02/Part05-集成Shiro实现个人账户-我的消息.html#_5-4-其他-layout-ftl-中-script-设置用户登录状态" class="sidebar-link">5.4 其他：layout.ftl 中 script 设置用户登录状态</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Chapter03</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Chapter04</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="part05-集成shiro实现个人账户-我的消息"><a href="#part05-集成shiro实现个人账户-我的消息" class="header-anchor">#</a> Part05-集成Shiro实现个人账户-我的消息</h1> <div class="language-text extra-class"><pre class="language-text"><code>blog
├─src
│  └─main
│      ├─java
│      │  └─org
│      │      └─myslayers
│      │          ├─controller
│      │          │      BaseController.java
│      │          │      UserController.java
│      │          │
│      │          ├─service
│      │          │  │  UserService.java
│      │          │  │
│      │          │  └─impl
│      │          │         UserServiceImpl.java
│      │          │
│      │          ├─vo
│      │          │      UserMessageVo.java
│      │          │
│      │          ├─shiro
│      │          │      AccountRealm.java
│      │
│      └─resources
│          ├─templates
│          │  ├─inc
│          │  │     layout.ftl
│          │  │
│          │  └─user
│          │        index.ftl
</code></pre></div><h2 id="_5-1-个人账户-我的消息【查询消息】"><a href="#_5-1-个人账户-我的消息【查询消息】" class="header-anchor">#</a> 5.1 个人账户：我的消息【查询消息】</h2> <ul><li><code>UserController.java</code> ：控制层，【查询消息】</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token keyword">extends</span> <span class="token class-name">BaseController</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 我的消息：查询消息
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/user/mess&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">mess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">IPage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserMessageVo</span><span class="token punctuation">&gt;</span></span> page <span class="token operator">=</span> messageService<span class="token punctuation">.</span><span class="token function">paging</span><span class="token punctuation">(</span><span class="token function">getPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserMessage</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;to_user_id&quot;</span><span class="token punctuation">,</span> <span class="token function">getProfileId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">orderByDesc</span><span class="token punctuation">(</span><span class="token string">&quot;created&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        req<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;pageData&quot;</span><span class="token punctuation">,</span> page<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;/user/mess&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><code>UserMessageVo.java</code> ：实体类</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserMessageVo</span> <span class="token keyword">extends</span> <span class="token class-name">UserMessage</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 我的消息的【接收消息的用户ID】-用户名name     未使用
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> toUserName<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 我的消息的【发送消息的用户ID】-用户名name
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> fromUserName<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 我的消息的【关联的文章ID】-文章标题title
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> postTitle<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 我的消息的【关联的文章-对应的评论ID】-评论内容content
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> commentContent<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><code>UserMessageMapper.xml</code> ：数据层实现</li></ul> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>selectMessages<span class="token punctuation">&quot;</span></span> <span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>org.myslayers.vo.UserMessageVo<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    SELECT m.*,
        (
            SELECT username
            FROM `m_user`
            WHERE id = m.from_user_id
        ) AS fromUserName,
        (
            SELECT title
            FROM `m_post`
            WHERE id = m.post_id
        ) AS postTitle,
        (
            SELECT content
            FROM `m_comment`
            WHERE id = m.comment_id
        ) AS commentContent
    FROM `m_user_message` m
        ${ew.customSqlSegment}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ul><li><code>index.ftl</code> ：模板引擎</li></ul> <div class="language-injectedfreemarker extra-class"><pre class="language-text"><code>&lt;#--宏layout.ftl（导航栏 + 页脚）--&gt;
&lt;#include &quot;/inc/layout.ftl&quot;/&gt;
&lt;#--宏common.ftl（个人账户-左侧链接（我的主页、用户中心、基本设置、我的消息），分页）--&gt;
&lt;#include &quot;/inc/common.ftl&quot;/&gt;

&lt;#--【三、填充（导航栏 + 页脚）】--&gt;
&lt;@layout &quot;用户中心&quot;&gt;

    &lt;div class=&quot;layui-container fly-marginTop fly-user-main&quot;&gt;
        &lt;#--用户中心-左侧链接（我的主页、用户中心、基本设置、我的消息）--&gt;
        &lt;@centerLeft level=3&gt;&lt;/@centerLeft&gt;

        &lt;div class=&quot;site-tree-mobile layui-hide&quot;&gt;
            &lt;i class=&quot;layui-icon&quot;&gt;&amp;#xe602;&lt;/i&gt;
        &lt;/div&gt;
        &lt;div class=&quot;site-mobile-shade&quot;&gt;&lt;/div&gt;

        &lt;div class=&quot;site-tree-mobile layui-hide&quot;&gt;
            &lt;i class=&quot;layui-icon&quot;&gt;&amp;#xe602;&lt;/i&gt;
        &lt;/div&gt;
        &lt;div class=&quot;site-mobile-shade&quot;&gt;&lt;/div&gt;

        &lt;div class=&quot;fly-panel fly-panel-user&quot; pad20&gt;
            &lt;div class=&quot;layui-tab layui-tab-brief&quot; lay-filter=&quot;user&quot; id=&quot;LAY_msg&quot; style=&quot;margin-top: 15px;&quot;&gt;
                &lt;button class=&quot;layui-btn layui-btn-danger&quot; id=&quot;LAY_delallmsg&quot;&gt;清空全部消息&lt;/button&gt;
                &lt;div id=&quot;LAY_minemsg&quot; style=&quot;margin-top: 10px;&quot;&gt;
                    &lt;ul class=&quot;mine-msg&quot;&gt;

                        &lt;#--我的消息的【消息的类型】：0代表系统消息、1代表评论的文章、2代表评论的评论--&gt;
                        &lt;#list pageData.records as mess&gt;
                            &lt;li data-id=&quot;${mess.id}&quot;&gt;
                                &lt;blockquote class=&quot;layui-elem-quote&quot;&gt;
                                    &lt;#if mess.type == 0&gt;
                                        系统消息：${mess.content}
                                    &lt;/#if&gt;
                                    &lt;#if mess.type == 1&gt;
                                        ${mess.fromUserName} 评论了你的文章 &lt;${mess.postTitle}&gt;，内容是 (${mess.commentContent})
                                    &lt;/#if&gt;
                                    &lt;#if mess.type == 2&gt;
                                        ${mess.fromUserName} 回复了你的评论 (${mess.commentContent})，文章是 &lt;${mess.postTitle}&gt;
                                    &lt;/#if&gt;
                                &lt;/blockquote&gt;
                                &lt;p&gt;
                                    &lt;span&gt;
                                        ${timeAgo(mess.created)}
                                    &lt;/span&gt;
                                    &lt;a class=&quot;layui-btn layui-btn-small layui-btn-danger fly-delete&quot; href=&quot;javascript:;&quot;&gt;
                                        删除
                                    &lt;/a&gt;
                                &lt;/p&gt;
                            &lt;/li&gt;
                        &lt;/#list&gt;

                    &lt;/ul&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;

    &lt;script&gt;
        layui.cache.page = 'user';
    &lt;/script&gt;

&lt;/@layout&gt;
</code></pre></div><h2 id="_5-2-个人账户-我的消息【删除单个消息-或-删除全部消息】"><a href="#_5-2-个人账户-我的消息【删除单个消息-或-删除全部消息】" class="header-anchor">#</a> 5.2 个人账户：我的消息【删除单个消息 或 删除全部消息】</h2> <ul><li><code>UserController.java</code> ：控制层，【删除单个消息 或 删除全部消息】</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token keyword">extends</span> <span class="token class-name">BaseController</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 我的消息：删除单个消息 或 删除全部消息（前端参数包含“all=true”，如果为ture时，使用【.eq(!all, &quot;id&quot;, id))】 删除全部消息）
     */</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/message/remove/&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">msgRemove</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>defaultValue <span class="token operator">=</span> <span class="token string">&quot;false&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Boolean</span> all<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> remove <span class="token operator">=</span> messageService<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserMessage</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;to_user_id&quot;</span><span class="token punctuation">,</span> <span class="token function">getProfileId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token operator">!</span>all<span class="token punctuation">,</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> remove <span class="token operator">?</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;删除失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 我的消息：使用layout.ftl中 利用session来实现【登录状态】 后，发现【接口异常】，
     *         查看后发现，【/res/mods/index.js】源码，【新消息通知 -&gt; layui.cache.user.uid !== -1】 -&gt; 因此补充 status、count 数据接口
     */</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/message/nums/&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Map</span> <span class="token function">msgNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> count <span class="token operator">=</span> messageService<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserMessage</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;to_user_id&quot;</span><span class="token punctuation">,</span> <span class="token function">getProfileId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//全部数量的消息</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;status&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span>           <span class="token comment">//未读的消息  未读0 已读1</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">MapUtil</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token string">&quot;status&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;count&quot;</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_5-3-个人账户-我的消息【消息弹窗】"><a href="#_5-3-个人账户-我的消息【消息弹窗】" class="header-anchor">#</a> 5.3 个人账户：我的消息【消息弹窗】</h2> <ul><li><code>UserController.java</code> ：控制层，【消息弹窗】</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token keyword">extends</span> <span class="token class-name">BaseController</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 我的消息：使用layout.ftl中 利用session来实现【登录状态】 后，发现【接口异常】，
     *         查看后发现，【/res/mods/index.js】源码，【新消息通知 -&gt; layui.cache.user.uid !== -1】 -&gt; 因此补充 status、count 数据接口
     */</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/message/nums/&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Map</span> <span class="token function">msgNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> count <span class="token operator">=</span> messageService<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserMessage</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;to_user_id&quot;</span><span class="token punctuation">,</span> <span class="token function">getProfileId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//全部数量的消息</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;status&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span>           <span class="token comment">//未读的消息  未读0 已读1</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">MapUtil</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token string">&quot;status&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;count&quot;</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><code>/res/mods/index.js</code> ：源码可知，如果 <code>res.status === 0 &amp;&amp; res.count &gt; 0</code>，会出现弹窗【你有 X 条未读消息】</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//新消息通知</span>
<span class="token function-variable function">newmsg</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> elemUser <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'.fly-nav-user'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>layui<span class="token punctuation">.</span>cache<span class="token punctuation">.</span>user<span class="token punctuation">.</span>uid <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> elemUser<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fly<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token string">'/message/nums/'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            _<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> res<span class="token punctuation">.</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">var</span> msg <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'&lt;a class=&quot;fly-nav-msg&quot; href=&quot;javascript:;&quot;&gt;'</span> <span class="token operator">+</span> res<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token string">'&lt;/a&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                elemUser<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                msg<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    fly<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token string">'/message/read'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">'/user/message/'</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                layer<span class="token punctuation">.</span><span class="token function">tips</span><span class="token punctuation">(</span><span class="token string">'你有 '</span> <span class="token operator">+</span> res<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token string">' 条未读消息'</span><span class="token punctuation">,</span> msg<span class="token punctuation">,</span> <span class="token punctuation">{</span>
                    tips<span class="token operator">:</span> <span class="token number">3</span>
                    <span class="token punctuation">,</span> tipsMore<span class="token operator">:</span> <span class="token boolean">true</span>
                    <span class="token punctuation">,</span> fixed<span class="token operator">:</span> <span class="token boolean">true</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                msg<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'mouseenter'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    layer<span class="token punctuation">.</span><span class="token function">closeAll</span><span class="token punctuation">(</span><span class="token string">'tips'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> arguments<span class="token punctuation">.</span>callee<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_5-4-其他-layout-ftl-中-script-设置用户登录状态"><a href="#_5-4-其他-layout-ftl-中-script-设置用户登录状态" class="header-anchor">#</a> 5.4 其他：<code>layout.ftl</code> 中 <code>script</code> 设置用户登录状态</h2> <ol><li>方式一：利用 shiro 来实现【登录状态】</li></ol> <ul><li><code>layout.ftl</code> ：模板引擎</li></ul> <div class="language-injectedfreemarker extra-class"><pre class="language-text"><code>&lt;#--宏：1.macro定义脚本，名为layout，参数为title--&gt;
&lt;#macro layout title&gt;
    &lt;!DOCTYPE html&gt;
    &lt;html&gt;
    &lt;head&gt;
        &lt;meta charset=&quot;utf-8&quot;&gt;
        &lt;title&gt;${title}&lt;/title&gt;
        &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1, maximum-scale=1&quot;&gt;
        &lt;meta name=&quot;keywords&quot; content=&quot;fly,layui,前端社区&quot;&gt;
        &lt;meta name=&quot;description&quot; content=&quot;Fly社区是模块化前端UI框架Layui的官网社区，致力于为web开发提供强劲动力&quot;&gt;
        &lt;link rel=&quot;stylesheet&quot; href=&quot;/res/layui/css/layui.css&quot;&gt;
        &lt;link rel=&quot;stylesheet&quot; href=&quot;/res/css/global.css&quot;&gt;

        &lt;#--导入script--&gt;
        &lt;script src=&quot;/res/layui/layui.js&quot;&gt;&lt;/script&gt;
        &lt;script src=&quot;/res/js/jquery.min.js&quot;&gt;&lt;/script&gt;
    &lt;/head&gt;
    &lt;body&gt;

    &lt;#--【一、导航栏】--&gt;
    &lt;#include &quot;/inc/header.ftl&quot;/&gt;

    &lt;#--【三、所有引用该“带有宏的标签layout.ftl”都会执行该操作：&lt;@layout &quot;首页&quot;&gt;&lt;/@layout&gt;中的数据 -&gt; 填充到&lt;#nested/&gt;标签中】--&gt;
    &lt;#nested&gt;

    &lt;#--【四、页脚】--&gt;
    &lt;#include &quot;/inc/footer.ftl&quot;/&gt;

    &lt;script&gt;
        &lt;#-----------------方式一：利用shiro来实现【登录状态】----------------------&gt;
        &lt;#--未登录的状态--&gt;
        &lt;#--【shiro.guest】：验证当前用户是否为 “访客”，即未认证（包含未记住）的用户--&gt;
        &lt;@shiro.guest&gt;
            // layui.cache.page = '';
            layui.cache.user = {
                username: '游客'
                , uid: -1
                , avatar: '/res/images/avatar/00.jpg'
                , experience: 83
                , sex: '男'
            };
            layui.config({
                version: &quot;3.0.0&quot;
                ,base: '/res/mods/' //这里实际使用时，建议改成绝对路径
            }).extend({
                fly: 'index'
            }).use('fly');
        &lt;/@shiro.guest&gt;

        &lt;#--登录后的状态--&gt;
        &lt;#--【shiro.user】：认证通过或已记住的用户--&gt;
        &lt;@shiro.user&gt;
            // layui.cache.page = '';
            layui.cache.user = {
                username: &lt;@shiro.principal property=&quot;username&quot;/&gt;
                , uid: &lt;@shiro.principal property=&quot;id&quot;/&gt;
                , avatar: &lt;@shiro.principal property=&quot;avatar&quot;/&gt;
                , experience: 83
                , sex: &lt;@shiro.principal property=&quot;gender&quot;/&gt;
            };
            layui.config({
                version: &quot;3.0.0&quot;
                , base: '/res/mods/' //这里实际使用时，建议改成绝对路径
            }).extend({
                fly: 'index'
            }).use('fly');
        &lt;/@shiro.user&gt;
    &lt;/script&gt;

    &lt;/body&gt;
    &lt;/html&gt;
&lt;/#macro&gt;
</code></pre></div><p>2.方式二：利用 session 来实现【登录状态】，修改【更新资料/更新头像】后，需要【手动更新 shiro/session 数据】</p> <ul><li><code>layout.ftl</code> ：模板引擎</li></ul> <div class="language-injectedfreemarker extra-class"><pre class="language-text"><code>&lt;#--宏：1.macro定义脚本，名为layout，参数为title--&gt;
&lt;#macro layout title&gt;
    &lt;!DOCTYPE html&gt;
    &lt;html&gt;
    &lt;head&gt;
        &lt;meta charset=&quot;utf-8&quot;&gt;
        &lt;title&gt;${title}&lt;/title&gt;
        &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1, maximum-scale=1&quot;&gt;
        &lt;meta name=&quot;keywords&quot; content=&quot;fly,layui,前端社区&quot;&gt;
        &lt;meta name=&quot;description&quot; content=&quot;Fly社区是模块化前端UI框架Layui的官网社区，致力于为web开发提供强劲动力&quot;&gt;
        &lt;link rel=&quot;stylesheet&quot; href=&quot;/res/layui/css/layui.css&quot;&gt;
        &lt;link rel=&quot;stylesheet&quot; href=&quot;/res/css/global.css&quot;&gt;

        &lt;#--导入script--&gt;
        &lt;script src=&quot;/res/layui/layui.js&quot;&gt;&lt;/script&gt;
        &lt;script src=&quot;/res/js/jquery.min.js&quot;&gt;&lt;/script&gt;
    &lt;/head&gt;
    &lt;body&gt;

    &lt;#--【一、导航栏】--&gt;
    &lt;#include &quot;/inc/header.ftl&quot;/&gt;

    &lt;#--【三、所有引用该“带有宏的标签layout.ftl”都会执行该操作：&lt;@layout &quot;首页&quot;&gt;&lt;/@layout&gt;中的数据 -&gt; 填充到&lt;#nested/&gt;标签中】--&gt;
    &lt;#nested&gt;

    &lt;#--【四、页脚】--&gt;
    &lt;#include &quot;/inc/footer.ftl&quot;/&gt;

    &lt;script&gt;
        &lt;#-----------------方式二：利用session来实现【登录状态】----------------------&gt;
        // layui.cache.page = '';
        layui.cache.user = {
            username: '${profile.username!&quot;游客&quot;}'
            , uid: ${profile.id!&quot;-1&quot;}
            , avatar: '${profile.avatar!&quot;/res/images/avatar/00.jpg&quot;}'
            , experience: 83
            , sex: '${profile.gender!&quot;男&quot;}'
        };

        layui.config({
            version: &quot;3.0.0&quot;
            , base: '/res/mods/' //这里实际使用时，建议改成绝对路径
        }).extend({
            fly: 'index'
        }).use('fly');
    &lt;/script&gt;

    &lt;/body&gt;
    &lt;/html&gt;
&lt;/#macro&gt;
</code></pre></div><ul><li><code>AccountRealm.java</code> ：配置类，【手动更新 shiro/session 数据】</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * AccountRealm：重写父类AuthorizingRealm方法
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountRealm</span> <span class="token keyword">extends</span> <span class="token class-name">AuthorizingRealm</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">AuthorizationInfo</span> <span class="token function">doGetAuthorizationInfo</span><span class="token punctuation">(</span><span class="token class-name">PrincipalCollection</span> principals<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">AuthenticationInfo</span> <span class="token function">doGetAuthenticationInfo</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationToken</span> token<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.获取Token</span>
        <span class="token class-name">UsernamePasswordToken</span> usernamePasswordToken <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UsernamePasswordToken</span><span class="token punctuation">)</span> token<span class="token punctuation">;</span>
        <span class="token comment">// 2.根据token获取username、password，并进行login登录，返回AccountProfile账户信息</span>
        <span class="token class-name">AccountProfile</span> profile <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>usernamePasswordToken<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>usernamePasswordToken<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3.通过profile、token.getCredentials()、getName()，获取AuthenticationInfo子接口对象（SimpleAuthenticationInfo）</span>
        <span class="token class-name">SimpleAuthenticationInfo</span> info <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleAuthenticationInfo</span><span class="token punctuation">(</span>profile<span class="token punctuation">,</span> token<span class="token punctuation">.</span><span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 方式二：利用session来实现【登录状态】，修改【更新资料/更新头像】后，需要【手动更新shiro/session数据】</span>
        <span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;profile&quot;</span><span class="token punctuation">,</span> profile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> info<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><code>UserController.java</code> ：控制层，【手动更新 shiro/session 数据】</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token keyword">extends</span> <span class="token class-name">BaseController</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 基本设置：更新资料
     */</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/user/set&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">doSet</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//校验：昵称不能为空</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;昵称不能为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//校验：从数据库中查询【username是否存在】、【id并非当前用户】，如果count &gt; 0，则代表“该昵称已被占用”</span>
        <span class="token keyword">int</span> count <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">,</span> <span class="token function">getProfile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">ne</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> <span class="token function">getProfileId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;该昵称已被占用&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//更新显示【数据库】：username、gender、sign -&gt; 数据库 -&gt; 刷新页面</span>
        <span class="token class-name">User</span> temp <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span><span class="token function">getProfileId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        temp<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        temp<span class="token punctuation">.</span><span class="token function">setGender</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getGender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        temp<span class="token punctuation">.</span><span class="token function">setSign</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getSign</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        userService<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//更新显示【Shiro】：更新 “AccountRealm类中，返回的AccountProfile对象” -&gt; 【header.ftl】</span>
        <span class="token class-name">AccountProfile</span> profile <span class="token operator">=</span> <span class="token function">getProfile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        profile<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span>temp<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        profile<span class="token punctuation">.</span><span class="token function">setSign</span><span class="token punctuation">(</span>temp<span class="token punctuation">.</span><span class="token function">getSign</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//方式二：利用session来实现【登录状态】，修改【更新资料/更新头像】后，需要【手动更新shiro/session数据】</span>
        <span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;profile&quot;</span><span class="token punctuation">,</span> profile<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token string">&quot;/user/set#info&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 基本设置：更新头像
     */</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/user/setAvatar&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">doAvatar</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getAvatar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//更新显示【数据库】：avatar -&gt; 数据库 -&gt; 刷新页面</span>
            <span class="token class-name">User</span> temp <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span><span class="token function">getProfileId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            temp<span class="token punctuation">.</span><span class="token function">setAvatar</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getAvatar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            userService<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//更新显示【Shiro】：更新 “AccountRealm类中，返回的AccountProfile对象” -&gt; 【header.ftl】</span>
            <span class="token class-name">AccountProfile</span> profile <span class="token operator">=</span> <span class="token function">getProfile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            profile<span class="token punctuation">.</span><span class="token function">setAvatar</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getAvatar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//方式二：利用session来实现【登录状态】，修改【更新资料/更新头像】后，需要【手动更新shiro/session数据】</span>
            <span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;profile&quot;</span><span class="token punctuation">,</span> profile<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token string">&quot;/user/set#avatar&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token string">&quot;/user/set#avatar&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/test/Chapter02/Part04-集成Shiro实现个人账户-用户中心.html" class="prev">
        Part04-集成Shiro实现个人账户-用户中心
      </a></span> <span class="next"><a href="/test/Chapter03/Part01-集成Shiro实现博客详情-收藏文章.html">
        Part01-集成Shiro实现博客详情-收藏文章
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/test/assets/js/app.6710735c.js" defer></script><script src="/test/assets/js/2.5b8d21c8.js" defer></script><script src="/test/assets/js/19.99769197.js" defer></script>
  </body>
</html>
